name: ChatOps

on: 
  issue_comment:
    types: [created, edited]

jobs:
  listen_comments:
    runs-on: ubuntu-latest
    # This job only runs for pull request comments
    if: ${{ github.event.issue.pull_request }}
    steps:
      - name: Listen for PR Comments
        uses: machine-learning-apps/actions-chatops@master
        with:
          TRIGGER_PHRASE: "!test"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: it
    outputs:
      run: ${{ steps.it.outputs.BOOL_TRIGGERED }}
      sha: ${{ steps.it.outputs.SHA }}

  run_tests:
    runs-on: ubuntu-latest
    needs: [listen_comments]
    if: needs.listen_comments.outputs.run == 'true'
    steps:
      - name: Set up Python 3.7
        uses: actions/setup-python@v1
        with:
          python-version: "3.7"

      - name: Get full Python version
        id: get-full-python-version
        run: echo ::set-output name=version::$(python -c "import sys; print('-'.join(str(v) for v in sys.version_info))")

      - name: Install Poetry
        uses: abatilo/actions-poetry@v2.0.0
        with:
          poetry-version: 1.1.4

      # NOTE: webhook イベントの制約により checkout の挙動が `poc-ci.yaml` とは若干異なる
      # - `poc-ci.yaml` の checkout: PR ブランチの head をベースブランチにマージしたコミット
      # - `poc-chatops.yaml` の checkout: PR ブランチの head コミット
      # (詳細: https://github.com/mc-digital/food_supply_chain/pull/754#discussion_r576513672)
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ needs.ilisten_commentst.outputs.sha }}

      - name: Post Comment
        uses: actions/github-script@v3
        env:
          MESSAGE: |
            :white_check_mark:
            Test succeeded on ${{ needs.listen_comments.outputs.sha }}
            workflow-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.MESSAGE
            })

  error_notification:
    runs-on: ubuntu-latest
    needs: [listen_comments, run_tests]
    if: failure() && needs.listen_comments.outputs.run == 'true'
    steps:
      - name: Post Comment
        uses: actions/github-script@v3
        env:
          MESSAGE: |
            :x:
            Test failed on ${{ needs.listen_comments.outputs.sha }}
            workflow-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.MESSAGE
            })
